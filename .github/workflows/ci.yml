name: CI / CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"

jobs:
  # ─── Typecheck & Lint ────────────────────────────────────
  typecheck-lint:
    name: Typecheck & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build shared types
        run: npm run build --workspace=@task-management/types

      - name: Generate Prisma client
        run: npx prisma generate --schema=apps/api/prisma/schema.prisma

      - name: Typecheck API
        run: npm run typecheck --workspace=@task-management/api

      - name: Lint API
        run: npm run lint --workspace=@task-management/api

  # ─── Tests ───────────────────────────────────────────────
  test:
    name: API Tests
    runs-on: ubuntu-latest
    needs: typecheck-lint

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build shared types
        run: npm run build --workspace=@task-management/types

      - name: Generate Prisma client
        run: npx prisma generate --schema=apps/api/prisma/schema.prisma

      - name: Run API tests
        run: npm run test --workspace=@task-management/api
        env:
          NODE_ENV: test
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_ACCESS_SECRET: ci-test-access-secret-must-be-32-chars!!
          JWT_REFRESH_SECRET: ci-test-refresh-secret-must-be-32-chars!
          JWT_ACCESS_EXPIRY_SECONDS: 900
          JWT_REFRESH_EXPIRY_SECONDS: 604800
          COOKIE_DOMAIN: localhost
          COOKIE_SECURE: "false"
          CORS_ORIGIN: http://localhost:3000
          ENABLE_EMAIL: "false"
          ENABLE_GOOGLE_OAUTH: "false"
          ENABLE_ASSIGNMENTS: "true"
          ENABLE_PASSWORD_RESET: "true"

  # ─── Deploy to DigitalOcean Droplet ──────────────────────
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: [typecheck-lint, test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy project to droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: "."
          target: "/opt/task-management"
          overwrite: true

      - name: Create .env and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            cd /opt/task-management

            # Create production .env from GitHub Secrets
            cat > apps/api/.env << 'ENVEOF'
            NODE_ENV=production
            PORT=3001
            HOST=0.0.0.0
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            DIRECT_URL=${{ secrets.DIRECT_URL }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PRIMARY_KEY=${{ secrets.REDIS_PRIMARY_KEY }}
            JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            JWT_ACCESS_EXPIRY_SECONDS=900
            JWT_REFRESH_EXPIRY_SECONDS=604800
            COOKIE_DOMAIN=${{ secrets.COOKIE_DOMAIN }}
            COOKIE_SECURE=true
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
            DD_API_KEY=${{ secrets.DD_API_KEY }}
            DD_SITE=${{ secrets.DD_SITE }}
            ENABLE_EMAIL=true
            ENABLE_GOOGLE_OAUTH=false
            ENABLE_ASSIGNMENTS=true
            ENABLE_PASSWORD_RESET=true
            ENVEOF

            # Trim leading whitespace from heredoc
            sed -i 's/^[[:space:]]*//' apps/api/.env

            # Run migrations first
            docker compose --profile tools run --rm migrate

            # Build and deploy all services
            docker compose up -d --build --remove-orphans

            # Wait for health checks
            echo "Waiting for API health check..."
            for i in $(seq 1 30); do
              if wget -qO- http://localhost:3001/api/v1/health > /dev/null 2>&1; then
                echo "API is healthy!"
                break
              fi
              echo "Attempt $i/30 — waiting..."
              sleep 5
            done

            # Show running containers
            docker compose ps

            # Cleanup old images
            docker image prune -f
